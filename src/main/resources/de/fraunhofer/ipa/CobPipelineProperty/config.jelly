<?jelly escape-by-default='true'?>
<j:jelly xmlns:j="jelly:core" xmlns:st="jelly:stapler" xmlns:d="jelly:define" xmlns:l="/lib/layout" xmlns:t="/lib/hudson" xmlns:f="/lib/form">
	<f:entry title="${%email}" field="email">
        <f:textbox />
	</f:entry>
	<f:entry title="${%defaultFork}" field="defaultFork">
        <f:textbox default="${descriptor.getGithubOrg()}"/>
	</f:entry>
	<f:entry title="${%defaultBranch}" field="defaultBranch">
        <f:textbox default="master"/>
	</f:entry>
	<f:block >
	    <f:hetero-list name="rootRepos" hasHeader="true"
	    			   descriptors="${descriptor.rootRepositoryDescriptors}"
	    			   items="${instance.rootRepos}"
	    			   addCaption="${%addRepo}"
	    			   deleteCaption="${%delRepo}"/>
	</f:block>
	<f:block>
		<table align="center" border="0" cellpadding="0" cellspacing="0" width="100%">
			<tbody><tr>
				<td width="150">
              		<div style="float:left" help="/plugin/cob-pipeline/help-generateButton.html">
			  			<input type="button" name="${%generate}" value="${%generate}" id="generateButton" style="margin-left:5em" onclick="generate()" onmouseover="updateGenButton(this.form)"/>
					</div>
              	</td>
              	<td width="*" style="vertical-align:middle">
              		<div id="status" />
              	</td>
            </tr><tr>
            	<td width="150"></td>
            	<td width="*">
              		<div id="msg" />
              	</td>
			</tr></tbody>
		</table>
  	</f:block>
  	<script>
  		var inst = <st:bind value="${instance}"/>
  		
  		var genButton = makeButton($('generateButton'),null);
  		
  		function generate(form) {
  			genButton.set('disabled',true,false);
  			document.getElementById('status').innerHTML = '<img src="${imagesURL}/spinner.gif" /> <b>${%generating}</b>';
  			document.getElementById('msg').innerHTML = '';
  			
			inst.doGeneratePipeline( function (t) 
			{
  				document.getElementById('status').innerHTML = '<b>' + t.responseObject().status + '</b>';
  				document.getElementById('msg').innerHTML = t.responseObject().message;
  				genButton.set('disabled',false,false);
  			});
			
  		}
  		  		
  		
  		function updateGenButton(form) {
	      	function state() {
		      	
				var repos = document.getElementsByName('repoName');
		      	
				if (repos.length!=0) {
		        	document.getElementById('status').innerHTML = "Ready";
		        	return false;
		        }
		        document.getElementById('status').innerHTML = "Choose one or more repositories to test!";
		        return true;
	      	}
	      
	      	genButton.set('disabled',state(),false);
	    }
	    updateGenButton(genButton.getForm());
  	</script>
</j:jelly>
